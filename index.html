<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Digitalisasi Panitia Pendidikan Islam</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        /* Modal Animation */
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-scale-in { animation: scale-in 0.2s ease-out forwards; }
        
        /* Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAr8-eH0oATCdR59srDYTHLM7F5CBOhwqY",
            authDomain: "etasmik-v2.firebaseapp.com",
            projectId: "etasmik-v2",
            storageBucket: "etasmik-v2.firebasestorage.app",
            messagingSenderId: "874131072411",
            appId: "1:874131072411:web:1f601643585fa1f6b7ed3e",
            measurementId: "G-WFB0RGZ99L"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- DATA HADIS ---
        const HADIS_DATA = [
            { text: "Sebaik-baik kamu adalah orang yang belajar Al-Qur'an dan mengajarkannya.", source: "Riwayat Al-Bukhari" },
            { text: "Orang yang mahir membaca Al-Qur'an akan bersama para malaikat yang mulia lagi taat.", source: "Riwayat Muslim" },
            { text: "Bacalah Al-Qur'an, kerana sesungguhnya ia akan datang pada hari kiamat sebagai pemberi syafaat kepada pembacanya.", source: "Riwayat Muslim" },
            { text: "Siapa yang menempuh jalan untuk mencari ilmu, maka Allah akan mudahkan baginya jalan menuju syurga.", source: "Riwayat Muslim" },
            { text: "Tuntutlah ilmu dari buaian hingga ke liang lahad.", source: "Kata Hikmah" }
        ];

        // --- IKON SVG ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Book = (props) => <IconBase {...props}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconBase>;
        const Users = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const History = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><polyline points="10 9 9 9 8 9"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Award = (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>;
        const UserPlus = (props) => <IconBase {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Shield = (props) => <IconBase {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Lock = (props) => <IconBase {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></IconBase>;
        const Edit2 = (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconBase>;
        const ArrowLeft = (props) => <IconBase {...props}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>;
        const BarChart2 = (props) => <IconBase {...props}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></IconBase>;
        const X = (props) => <IconBase {...props}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>;
        const Home = (props) => <IconBase {...props}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>;
        const Clipboard = (props) => <IconBase {...props}><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const Database = (props) => <IconBase {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></IconBase>;
        const Settings = (props) => <IconBase {...props}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0 .33-1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></IconBase>;
        const BookOpen = (props) => <IconBase {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></IconBase>;

        const LEVELS = ['Iqra 1', 'Iqra 2', 'Iqra 3', 'Iqra 4', 'Iqra 5', 'Iqra 6', 'Al-Quran'];
        const RATINGS = ['Lancar', 'Sederhana', 'Perlu Bimbingan'];
        const TP_LEVELS = ['TP1', 'TP2', 'TP3', 'TP4', 'TP5', 'TP6'];
        const HASIL_KERJA_LEVELS = ['Lemah', 'Baik', 'Cemerlang'];

        // --- PENGIRAAN JUZUK TEPAT ---
        const getExactJuzuk = (page) => {
            const p = parseInt(page);
            if (isNaN(p) || p < 1) return '-';
            const juzukStart = [
                0, 1, 22, 42, 62, 82, 102, 122, 142, 162, 182, 
                202, 222, 242, 262, 282, 302, 322, 342, 362, 382, 
                402, 422, 442, 462, 482, 502, 522, 542, 562, 582
            ];
            for (let i = 30; i >= 1; i--) {
                if (p >= juzukStart[i]) return i;
            }
            return 1;
        };

        // --- KOMPONEN UI ---
        const Card = ({ children, className = "", onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-xl shadow-sm border border-emerald-100 p-4 ${onClick ? 'cursor-pointer hover:shadow-md hover:border-emerald-300 transition-all active:scale-95' : ''} ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = 'primary', className = "", disabled = false, ...props }) => {
            const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md shadow-emerald-200",
                secondary: "bg-white text-emerald-700 border border-emerald-200 hover:bg-emerald-50",
                danger: "bg-red-50 text-red-600 border border-red-100 hover:bg-red-100",
                ghost: "bg-transparent text-gray-500 hover:bg-gray-100",
                google: "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50",
                sidebar: "w-full justify-start text-emerald-100 hover:bg-emerald-700 hover:text-white"
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${disabled ? 'opacity-50 cursor-not-allowed' : ''} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const Badge = ({ status }) => {
            const styles = {
                'Lancar': 'bg-green-100 text-green-700',
                'Sederhana': 'bg-yellow-100 text-yellow-700',
                'Perlu Bimbingan': 'bg-red-100 text-red-700',
            };
            return (
                <span className={`text-xs px-2 py-1 rounded-full font-semibold ${styles[status] || 'bg-gray-100 text-gray-600'}`}>
                    {status}
                </span>
            );
        };

        const KhatamBadge = () => (
            <span className="flex items-center gap-1 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-bold border border-yellow-200">
                <Award size={12} className="fill-yellow-500 text-yellow-600" /> KHATAM
            </span>
        );

        const DailyHadis = () => {
            const [hadis, setHadis] = React.useState(HADIS_DATA[0]);
            
            React.useEffect(() => {
                const random = HADIS_DATA[Math.floor(Math.random() * HADIS_DATA.length)];
                setHadis(random);
            }, []);

            return (
                <div className="bg-gradient-to-r from-emerald-800 to-teal-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden mb-8">
                    <div className="absolute top-0 right-0 p-4 opacity-10">
                        <BookOpen size={100} />
                    </div>
                    <div className="relative z-10">
                        <h3 className="text-emerald-300 text-xs font-bold tracking-widest uppercase mb-2">Mutiara Kata / Hadis</h3>
                        <p className="text-xl md:text-2xl font-serif leading-relaxed mb-4">"{hadis.text}"</p>
                        <p className="text-sm text-emerald-200 font-medium border-l-2 border-emerald-500 pl-3">{hadis.source}</p>
                    </div>
                </div>
            );
        };

        // --- NEW: KOMPONEN CARTA/GRAF BAR (Analisis Grafik) ---
        const StatsChart = ({ stats }) => {
            const iqraLabels = ['Iqra 1', 'Iqra 2', 'Iqra 3', 'Iqra 4', 'Iqra 5', 'Iqra 6'];
            const iqraData = iqraLabels.map(l => ({ label: l, value: stats.iqra[l] || 0 }));
            
            const quranLabels = Object.keys(stats.quran);
            const quranData = quranLabels.map(l => ({ label: `Juz ${l}`, value: stats.quran[l] || 0 }));

            const maxValueIqra = Math.max(...iqraData.map(d => d.value), 1);
            const maxValueQuran = Math.max(...quranData.map(d => d.value), 1);

            const renderBar = (item, max, colorClass) => (
                <div key={item.label} className="flex flex-col items-center gap-1 flex-1 group h-full justify-end">
                    <div className="w-full relative flex items-end justify-center" style={{height: '100px'}}>
                        <div 
                            className={`w-full ${colorClass} rounded-t-sm transition-all duration-1000 ease-out group-hover:opacity-80 relative flex justify-center`} 
                            style={{ height: `${(item.value / max) * 100}%` }}
                        >
                            <span className="absolute -top-5 text-xs font-bold text-gray-700 opacity-0 group-hover:opacity-100 transition-opacity">{item.value}</span>
                        </div>
                    </div>
                    <span className="text-[9px] md:text-[10px] text-gray-500 font-medium text-center leading-tight h-6 flex items-center justify-center">{item.label.replace('Iqra', 'Iq').replace('Juz', '')}</span>
                </div>
            );

            return (
                <div className="grid md:grid-cols-2 gap-6 mb-6 animate-fade-in-up">
                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <h4 className="font-bold text-blue-700 mb-4 text-sm flex items-center gap-2"><BarChart2 size={16}/> Taburan Murid Iqra'</h4>
                        <div className="flex items-end justify-between gap-1 h-32">
                            {iqraData.map(d => renderBar(d, maxValueIqra, 'bg-blue-500'))}
                        </div>
                    </div>
                    <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <h4 className="font-bold text-emerald-700 mb-4 text-sm flex items-center gap-2"><BookOpen size={16}/> Taburan Murid Al-Quran</h4>
                        <div className="flex items-end justify-between gap-1 h-32">
                            {quranData.map(d => renderBar(d, maxValueQuran, 'bg-emerald-500'))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- GOOGLE SHEETS SYNC HELPER ---
        const syncToGoogleSheets = async (data, settings) => {
            if (!settings || !settings.googleScriptUrl) return;
            try {
                await fetch(settings.googleScriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log("Data dihantar ke Google Sheets (Background)");
            } catch (error) {
                console.error("Ralat Sync Google Sheets:", error);
            }
        };

        // --- MODAL TAMBAH MURID ---
        const AddStudentModal = ({ onClose, onSave, existingClasses }) => {
            const [name, setName] = React.useState('');
            const [kelas, setKelas] = React.useState('');
            
            const handleSubmit = () => {
                if(!name || !kelas) return alert("Sila isi nama dan kelas.");
                onSave(name, kelas);
            }

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in-up backdrop-blur-sm" onClick={e => onClose()}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 animate-scale-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-emerald-800 flex items-center gap-2"><UserPlus size={20}/> Tambah Murid Manual</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={20}/></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">Nama Murid</label>
                                <input type="text" className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" value={name} onChange={e => setName(e.target.value)} placeholder="Nama Penuh" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1 text-gray-700">Kelas</label>
                                <input list="classes" type="text" className="w-full border border-gray-300 p-2.5 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" value={kelas} onChange={e => setKelas(e.target.value)} placeholder="Pilih atau taip baru..." />
                                <datalist id="classes">
                                    {existingClasses.map(c => <option key={c} value={c} />)}
                                </datalist>
                                <p className="text-[10px] text-gray-400 mt-1">Anda boleh pilih kelas sedia ada atau taip nama kelas baru.</p>
                            </div>
                            <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
                                <Button variant="ghost" onClick={onClose}>Batal</Button>
                                <Button onClick={handleSubmit}>Simpan Murid</Button>
                            </div>
                        </div>
                    </div>
                </div>
            )
        }

        // --- MODAL ANALISIS ---
        const AnalysisModal = ({ title, data, onClose, onSelectStudent }) => {
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in-up backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[85vh] flex flex-col animate-scale-in" onClick={e => e.stopPropagation()}>
                        <div className="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                            <div>
                                <h3 className="font-bold text-lg text-gray-800">{title}</h3>
                                <p className="text-xs text-gray-500">{data.length} murid dijumpai</p>
                            </div>
                            <button onClick={onClose} className="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition-colors"><X size={18}/></button>
                        </div>
                        <div className="overflow-y-auto p-4 space-y-2 flex-1 bg-gray-50/50">
                            {data.length === 0 ? <p className="text-center text-gray-400 py-10 italic">Tiada murid dalam kategori ini.</p> : 
                            data.map(s => (
                                <div key={s.id} onClick={() => onSelectStudent(s)} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm hover:shadow-md hover:border-emerald-300 cursor-pointer flex justify-between items-center group transition-all">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold ${s.level === 'Al-Quran' ? 'bg-emerald-500' : 'bg-blue-400'}`}>{s.name.charAt(0)}</div>
                                        <div>
                                            <div className="flex items-center gap-1">
                                                <p className="font-bold text-sm text-gray-800 group-hover:text-emerald-700">{s.name}</p>
                                                {s.isKhatam && <Award size={12} className="text-yellow-500 fill-yellow-400"/>}
                                            </div>
                                            <p className="text-[10px] text-gray-500">{s.class} • {s.level} {s.level === 'Al-Quran' && `(Juz ${getExactJuzuk(s.page)})`}</p>
                                        </div>
                                    </div>
                                    <div className="text-emerald-600 opacity-0 group-hover:opacity-100 transform translate-x-2 group-hover:translate-x-0 transition-all">
                                        <ChevronRight size={16} />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PBD EDIT MODAL (FOR MOBILE) ---
        const PBDEditModal = ({ student, onClose, onUpdate }) => {
            const pbd = student.pbd_scores || {};
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 animate-fade-in-up backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-scale-in" onClick={e => e.stopPropagation()}>
                        <div className="p-5 border-b flex justify-between items-center bg-emerald-600 rounded-t-2xl text-white">
                            <div>
                                <h3 className="font-bold text-lg">{student.name}</h3>
                                <p className="text-xs text-emerald-100">{student.class} • {student.level}</p>
                            </div>
                            <button onClick={onClose} className="bg-white/20 hover:bg-white/30 p-2 rounded-full"><X size={18}/></button>
                        </div>
                        <div className="p-6 space-y-4">
                            {['aq_quran', 'akidah', 'ibadah', 'sirah', 'adab', 'jawi'].map(field => (
                                <div key={field} className="flex items-center justify-between border-b pb-2">
                                    <label className="font-medium text-gray-700 capitalize">{field.replace('_', ' ')}</label>
                                    <select 
                                        className="p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-emerald-500 min-w-[100px]"
                                        value={pbd[field] || ''}
                                        onChange={(e) => onUpdate(student.id, field, e.target.value)}
                                    >
                                        <option value="">-</option>
                                        {TP_LEVELS.map(tp => <option key={tp} value={tp}>{tp}</option>)}
                                    </select>
                                </div>
                            ))}
                            <div className="flex items-center justify-between border-b pb-2">
                                <label className="font-medium text-gray-700 capitalize">Hasil Kerja</label>
                                <select 
                                    className="p-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-emerald-500 min-w-[100px]"
                                    value={pbd['hasil_kerja'] || ''}
                                    onChange={(e) => onUpdate(student.id, 'hasil_kerja', e.target.value)}
                                >
                                    <option value="">-</option>
                                    {HASIL_KERJA_LEVELS.map(val => <option key={val} value={val}>{val}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center justify-between pt-2">
                                <label className="font-bold text-blue-700 capitalize">Keseluruhan</label>
                                <select 
                                    className="p-2 border border-blue-300 rounded-lg bg-blue-50 focus:ring-2 focus:ring-blue-500 min-w-[100px] font-bold text-blue-800"
                                    value={pbd['keseluruhan'] || ''}
                                    onChange={(e) => onUpdate(student.id, 'keseluruhan', e.target.value)}
                                >
                                    <option value="">-</option>
                                    {TP_LEVELS.map(tp => <option key={tp} value={tp}>{tp}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 rounded-b-2xl">
                             <Button onClick={onClose} className="w-full">Selesai</Button>
                        </div>
                    </div>
                </div>
            );
        };

        const { useState, useEffect, useRef, useMemo } = React;

        // --- KOMPONEN DASHBOARD (DIPINDAHKAN KELUAR) ---
        const Dashboard = ({ 
            currentUser, 
            students, 
            searchTerm, 
            setSearchTerm, 
            filterClass, 
            setFilterClass, 
            assignedClass, 
            setAssignedClass, 
            myClasses, 
            analysisStats, 
            setView, 
            setSelectedStudent, 
            handleDeleteHalaqah, 
            handleDeleteStudent,
            uniqueClasses
        }) => {
            const [analysisModal, setAnalysisModal] = useState(null); 
            // Filter baseSubset mengikut kelas yang dipilih untuk tujuan analisis
            const baseSubset = useMemo(() => {
                if (currentUser.role === 'admin') {
                    return students.filter(s => filterClass === 'Semua' || s.class === filterClass);
                } else {
                    if (assignedClass) return students.filter(s => s.class === assignedClass);
                    return students.filter(s => s.assignedTeacherEmail === currentUser.email);
                }
            }, [students, filterClass, assignedClass, currentUser]);
            
            const filteredStudents = useMemo(() => {
                    if (currentUser.role === 'admin') {
                    return students.filter(s => {
                        const matchName = s.name.toLowerCase().includes(searchTerm.toLowerCase());
                        const matchClass = filterClass === 'Semua' || s.class === filterClass;
                        return matchName && matchClass;
                    });
                } else {
                    if (!assignedClass) return [];
                    return students.filter(s => 
                        s.assignedTeacherEmail === currentUser.email && 
                        s.class === assignedClass &&
                        s.name.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
            }, [students, currentUser, filterClass, searchTerm, assignedClass]);

            const handleShowAnalysis = (type, param) => {
                let list = [];
                let title = '';
                // Gunakan baseSubset (yang sudah ditapis ikut kelas) untuk senarai modal
                if (type === 'total') { list = baseSubset; title = `Semua Murid`; }
                else if (type === 'iqra_total') { list = baseSubset.filter(s => s.level.startsWith('Iqra')); title = 'Semua Murid Iqra'; }
                else if (type === 'quran_total') { list = baseSubset.filter(s => s.level === 'Al-Quran'); title = 'Semua Murid Al-Quran'; }
                else if (type === 'khatam') { list = baseSubset.filter(s => s.isKhatam); title = 'Murid Telah Khatam'; }
                else if (type === 'iqra_level') { list = baseSubset.filter(s => s.level === param); title = `Murid ${param}`; }
                else if (type === 'quran_juz') {
                    const [start, end] = param.split('-').map(Number);
                    list = baseSubset.filter(s => {
                        if (s.level !== 'Al-Quran') return false;
                        const j = getExactJuzuk(s.page);
                        return typeof j === 'number' && j >= start && j <= end;
                    });
                    title = `Murid Juzuk ${param}`;
                }
                setAnalysisModal({ title, students: list });
            };

            const HalaqahGrid = ({ onClickClass }) => (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                    {myClasses.map(className => (
                        <div key={className} className="relative group">
                            <div onClick={() => onClickClass(className)} className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:border-emerald-300 hover:shadow-md cursor-pointer transition-all flex justify-between items-center">
                                <div><h3 className="font-bold text-lg text-gray-800">{className}</h3><p className="text-sm text-gray-500">{students.filter(s => s.class === className && s.assignedTeacherEmail === currentUser.email).length} Murid</p></div>
                                <div className="bg-emerald-50 p-2 rounded-full group-hover:bg-emerald-100 transition-colors"><ChevronRight className="text-emerald-600" /></div>
                            </div>
                            <button onClick={(e) => { e.stopPropagation(); handleDeleteHalaqah(className); }} className="absolute top-4 right-4 text-gray-300 hover:text-red-500 p-2 bg-white rounded-full hover:bg-red-50 transition-colors z-10" title="Padam Halaqah Ini"><Trash2 size={16} /></button>
                        </div>
                    ))}
                </div>
            );

            // VIEW: HALAQAH SELECTION (TEACHER OVERVIEW)
            if (currentUser.role === 'teacher' && !assignedClass) {
                return (
                    <div className="p-4 max-w-4xl mx-auto">
                        <div className="flex justify-between items-end mb-4">
                            <h2 className="text-xl font-bold text-gray-800">Halaqah Tasmik Anda</h2>
                            <Button onClick={() => setView('setup_halaqah')} className="text-sm px-4 py-2"><Plus size={16}/> Tambah Halaqah</Button>
                        </div>
                        
                        {/* ANALISIS RINGKAS UNTUK GURU (OVERVIEW) */}
                        <div className="mb-8">
                             <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                                <h3 className="font-bold text-gray-700 flex items-center gap-2 mb-4"><BarChart2 size={18}/> Statistik Keseluruhan Pelajar Anda</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                    <Card onClick={() => handleShowAnalysis('iqra_total')} className="bg-blue-50 border border-blue-100 text-center cursor-pointer hover:bg-blue-50"><div className="text-2xl font-bold text-blue-600">{analysisStats.totalIqra}</div><div className="text-[10px] text-blue-400 font-bold uppercase">Total Iqra</div></Card>
                                    <Card onClick={() => handleShowAnalysis('quran_total')} className="bg-emerald-50 border border-emerald-100 text-center cursor-pointer hover:bg-emerald-50"><div className="text-2xl font-bold text-emerald-600">{analysisStats.totalQuran}</div><div className="text-[10px] text-emerald-400 font-bold uppercase">Total Quran</div></Card>
                                    <Card onClick={() => handleShowAnalysis('khatam')} className="bg-yellow-50 border border-yellow-100 text-center cursor-pointer hover:bg-yellow-50"><div className="text-2xl font-bold text-yellow-600">{analysisStats.khatam}</div><div className="text-[10px] text-yellow-500 font-bold uppercase">Khatam</div></Card>
                                    <Card onClick={() => handleShowAnalysis('total')} className="bg-gray-50 border border-gray-200 text-center cursor-pointer hover:bg-gray-50"><div className="text-2xl font-bold text-gray-600">{analysisStats.total}</div><div className="text-[10px] text-gray-400 font-bold uppercase">Jumlah Murid</div></Card>
                                </div>
                                <StatsChart stats={analysisStats} />
                            </div>
                        </div>

                        {myClasses.length === 0 ? (
                            <div className="text-center py-12 text-gray-400 border-2 border-dashed border-gray-200 rounded-xl">
                                <Users size={48} className="mx-auto mb-2 opacity-20" />
                                <p>Anda belum ada murid.</p>
                                <p className="text-sm mt-1">Tekan "Tambah Halaqah" untuk mula.</p>
                            </div>
                        ) : (
                            <HalaqahGrid onClickClass={(c) => setAssignedClass(c)} />
                        )}
                    </div>
                );
            }

            // VIEW: STUDENT LIST (ADMIN & TEACHER DETAIL)
            return (
                <div className="p-4 max-w-4xl mx-auto">
                    {analysisModal && <AnalysisModal title={analysisModal.title} data={analysisModal.students} onClose={() => setAnalysisModal(null)} onSelectStudent={(s) => { setAnalysisModal(null); setSelectedStudent(s); setView('student_detail'); }} />}
                    
                    {/* Header Controls Teacher */}
                    {currentUser.role === 'teacher' && (
                        <div className="bg-emerald-600 text-white p-3 rounded-lg mb-4 flex justify-between items-center shadow-md">
                            <button onClick={() => setAssignedClass(null)} className="flex items-center gap-1 hover:underline"><ArrowLeft size={18}/> <span className="font-bold">{assignedClass}</span></button>
                            <button onClick={() => setView('setup_halaqah')} className="bg-white/20 p-2 rounded-full hover:bg-white/30 text-xs flex items-center gap-1"><Edit2 size={16}/> <span className="hidden sm:inline">Edit</span></button>
                        </div>
                    )}

                    {/* STATS SECTION (Shared: Admin & Teacher Class View) */}
                    <div className="space-y-6 mb-8">
                        {/* CLASS FILTER (GLOBAL FOR ADMIN) */}
                        {currentUser.role === 'admin' && (
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center gap-3 overflow-x-auto no-scrollbar">
                                <span className="font-bold text-sm text-gray-700 whitespace-nowrap">Filter Kelas:</span>
                                {['Semua', ...uniqueClasses].map(c => (
                                    <button key={c} onClick={() => setFilterClass(c)} className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${filterClass === c ? 'bg-emerald-600 text-white shadow' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>{c}</button>
                                ))}
                            </div>
                        )}

                        {currentUser.role === 'admin' && (
                            <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-emerald-800 flex items-center gap-2"><Users size={18}/> Tugas Hakiki (Halaqah Saya)</h3>
                                    <Button onClick={() => setView('setup_halaqah')} variant="secondary" className="text-xs py-1 px-3 bg-white">Setup Halaqah</Button>
                                </div>
                                {myClasses.length > 0 ? <HalaqahGrid onClickClass={(c) => setFilterClass(c)} /> : <p className="text-sm text-gray-500 italic">Anda belum memilih halaqah sendiri. Tekan Setup untuk mula.</p>}
                            </div>
                        )}

                        {/* UNIVERSAL ANALYSIS CHART - VISIBLE TO BOTH ADMIN & TEACHER */}
                        <div className="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <div className="flex justify-between items-center mb-4 border-b pb-2">
                                <h3 className="font-bold text-gray-700 flex items-center gap-2"><BarChart2 size={18}/> Analisis Data</h3>
                                <span className="text-xs font-medium bg-gray-100 px-2 py-1 rounded">
                                    {currentUser.role === 'admin' ? `Filter: ${filterClass}` : `Kelas: ${assignedClass || 'Semua'}`}
                                </span>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                <Card onClick={() => handleShowAnalysis('iqra_total')} className="bg-blue-50 border border-blue-100 text-center cursor-pointer hover:bg-blue-50"><div className="text-2xl font-bold text-blue-600">{analysisStats.totalIqra}</div><div className="text-[10px] text-blue-400 font-bold uppercase">Total Iqra</div></Card>
                                <Card onClick={() => handleShowAnalysis('quran_total')} className="bg-emerald-50 border border-emerald-100 text-center cursor-pointer hover:bg-emerald-50"><div className="text-2xl font-bold text-emerald-600">{analysisStats.totalQuran}</div><div className="text-[10px] text-emerald-400 font-bold uppercase">Total Quran</div></Card>
                                <Card onClick={() => handleShowAnalysis('khatam')} className="bg-yellow-50 border border-yellow-100 text-center cursor-pointer hover:bg-yellow-50"><div className="text-2xl font-bold text-yellow-600">{analysisStats.khatam}</div><div className="text-[10px] text-yellow-500 font-bold uppercase">Khatam</div></Card>
                                <Card onClick={() => handleShowAnalysis('total')} className="bg-gray-50 border border-gray-200 text-center cursor-pointer hover:bg-gray-50"><div className="text-2xl font-bold text-gray-600">{analysisStats.total}</div><div className="text-[10px] text-gray-400 font-bold uppercase">Jumlah Murid</div></Card>
                            </div>
                            
                            {/* GRAF DISINI - KELIHATAN UNTUK SEMUA */}
                            <StatsChart stats={analysisStats} />
                        </div>
                    </div>

                    {/* Student List */}
                    <div className="bg-white p-4 rounded-xl shadow-sm mb-4 sticky top-0 z-10 border border-gray-100">
                            <div className="relative mb-3">
                            <Search className="absolute left-3 top-2.5 text-gray-400" size={18} />
                            <input type="text" placeholder="Cari nama murid..." className="w-full pl-10 pr-4 py-2 bg-gray-50 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                    </div>

                        <div className="space-y-3 pb-20">
                        {filteredStudents.length > 0 ? filteredStudents.map(student => (
                            <div key={student.id} onClick={() => { setSelectedStudent(student); setView('student_detail'); }} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md cursor-pointer flex justify-between items-center relative overflow-hidden group">
                                {student.isKhatam && <div className="absolute top-0 right-0 w-3 h-3 bg-yellow-400 rounded-bl-lg"></div>}
                                <div className="flex items-center gap-4">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold relative ${student.level === 'Al-Quran' ? 'bg-emerald-500' : 'bg-blue-400'}`}>{student.name.charAt(0)}</div>
                                    <div>
                                        <div className="flex items-center gap-2"><h4 className="font-bold text-gray-800">{student.name}</h4>{student.isKhatam && <KhatamBadge />}</div>
                                        <div className="flex gap-2 items-center text-xs text-gray-500"><span>{student.class}</span><span>• {student.level} ({student.page})</span></div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <Badge status={student.status} />
                                    {currentUser.role === 'admin' && <button onClick={(e) => { e.stopPropagation(); handleDeleteStudent(student.id, student.name); }} className="p-2 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Padam Murid"><Trash2 size={18} /></button>}
                                </div>
                            </div>
                        )) : (
                            <div className="text-center py-12 text-gray-400"><Users size={48} className="mx-auto mb-2 opacity-20" /><p>Tiada murid dijumpai.</p></div>
                        )}
                    </div>
                </div>
            );
        };

        // --- PBD LIST COMPONENT ---
        const PBDList = () => {
            return null; // Placeholder
        };
        
        // --- VIEW: PBD LIST (FULL CODE) ---
        const PBDListScreen = ({ students, uniqueClasses, handleUpdatePBD }) => {
            const [selectedClass, setSelectedClass] = useState(''); // Default kosong
            const [editStudent, setEditStudent] = useState(null);
            
            const classStudents = useMemo(() => {
                if (!selectedClass) return [];
                return students.filter(s => s.class === selectedClass).sort((a,b) => a.name.localeCompare(b.name));
            }, [students, selectedClass]);

            const handlePrint = () => {
                if(!selectedClass) return alert("Sila pilih kelas dahulu.");
                const printWindow = window.open('', '', 'width=800,height=600');
                const html = `
                    <html>
                    <head>
                        <title>PBD - ${selectedClass}</title>
                        <style>
                            body { font-family: sans-serif; padding: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 12px; }
                            th { background-color: #f0f0f0; }
                            .text-left { text-align: left; }
                            h1, h2 { text-align: center; margin: 0; }
                            .header { margin-bottom: 20px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Rekod Pentaksiran Bilik Darjah (PBD)</h1>
                            <h2>Kelas: ${selectedClass}</h2>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Bil</th>
                                    <th>Nama Murid</th>
                                    <th>AQ</th>
                                    <th>Akidah</th>
                                    <th>Ibadah</th>
                                    <th>Sirah</th>
                                    <th>Adab</th>
                                    <th>Jawi</th>
                                    <th>Hasil Kerja</th>
                                    <th>Keseluruhan</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classStudents.map((s, i) => {
                                    const pbd = s.pbd_scores || {};
                                    return `
                                        <tr>
                                            <td>${i + 1}</td>
                                            <td class="text-left">${s.name}</td>
                                            <td>${pbd.aq_quran || '-'}</td>
                                            <td>${pbd.akidah || '-'}</td>
                                            <td>${pbd.ibadah || '-'}</td>
                                            <td>${pbd.sirah || '-'}</td>
                                            <td>${pbd.adab || '-'}</td>
                                            <td>${pbd.jawi || '-'}</td>
                                            <td>${pbd.hasil_kerja || '-'}</td>
                                            <td>${pbd.keseluruhan || '-'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        <script>window.print();<\/script>
                    </body>
                    </html>
                `;
                printWindow.document.write(html);
                printWindow.document.close();
            };

            const handleDownloadCSV = () => {
                if(!selectedClass) return alert("Sila pilih kelas dahulu.");
                let csvContent = "data:text/csv;charset=utf-8,Bil,Nama Murid,Kelas,AQ,Akidah,Ibadah,Sirah,Adab,Jawi,Hasil Kerja,Keseluruhan\n";
                classStudents.forEach((s, index) => {
                    const pbd = s.pbd_scores || {};
                    csvContent += `${index+1},"${s.name}",${s.class},${pbd.aq_quran||''},${pbd.akidah||''},${pbd.ibadah||''},${pbd.sirah||''},${pbd.adab||''},${pbd.jawi||''},${pbd.hasil_kerja||''},${pbd.keseluruhan||''}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `PBD_${selectedClass}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            return (
                <div className="p-4 md:p-6 min-h-screen pb-20 overflow-x-hidden">
                    {editStudent && <PBDEditModal student={editStudent} onClose={() => setEditStudent(null)} onUpdate={handleUpdatePBD} />}

                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4 border-b pb-6">
                        <div>
                            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Clipboard className="text-blue-600"/> Pentaksiran Bilik Darjah</h2>
                            <p className="text-sm text-gray-500 mb-2">Pilih kelas untuk melihat senarai dan mengisi PBD.</p>
                            
                            <div className="flex items-center gap-2">
                                <span className="font-bold text-gray-700">Kelas:</span>
                                <select 
                                    className="border border-gray-300 rounded-lg p-2 bg-white shadow-sm min-w-[200px] outline-none focus:ring-2 focus:ring-blue-500" 
                                    value={selectedClass} 
                                    onChange={(e) => setSelectedClass(e.target.value)}
                                >
                                    <option value="">-- Sila Pilih Kelas --</option>
                                    {uniqueClasses.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>

                        {selectedClass && (
                            <div className="flex gap-2">
                                <button onClick={handleDownloadCSV} className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow transition-all text-sm font-medium">
                                    <Download size={16}/> CSV
                                </button>
                                <button onClick={handlePrint} className="flex items-center gap-2 bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-900 shadow transition-all text-sm font-medium">
                                    <Printer size={16} /> Cetak
                                </button>
                            </div>
                        )}
                    </div>

                    {!selectedClass ? (
                        <div className="flex flex-col items-center justify-center py-20 text-gray-400 bg-white rounded-xl border border-dashed border-gray-300">
                            <Clipboard size={64} className="mb-4 opacity-20"/>
                            <p className="text-lg font-medium">Sila pilih kelas di atas untuk memaparkan senarai murid.</p>
                        </div>
                    ) : (
                        <>
                            {/* Mobile View (List/Card) */}
                            <div className="block md:hidden space-y-3">
                                <p className="text-xs text-gray-500 italic mb-2">* Tekan nama murid untuk isi PBD</p>
                                {classStudents.map(student => {
                                    const pbd = student.pbd_scores || {};
                                    return (
                                        <div key={student.id} onClick={() => setEditStudent(student)} className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold">{student.name.charAt(0)}</div>
                                                <div>
                                                    <h4 className="font-bold text-gray-800">{student.name}</h4>
                                                    <p className="text-xs text-gray-500">{student.level} • {pbd.keseluruhan ? `TP${pbd.keseluruhan}` : 'Belum Isi'}</p>
                                                </div>
                                            </div>
                                            <ChevronRight size={18} className="text-gray-400" />
                                        </div>
                                    );
                                })}
                            </div>

                            {/* Desktop View (Table) */}
                            <div className="hidden md:block bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-50 text-gray-700 font-bold border-b">
                                            <tr>
                                                <th className="p-4 min-w-[200px] sticky left-0 bg-gray-50 z-10 shadow-r">Nama Murid</th>
                                                <th className="p-4 min-w-[150px] bg-emerald-50 text-emerald-800">Tasmik</th>
                                                <th className="p-4 min-w-[80px]">AQ</th>
                                                <th className="p-4 min-w-[80px]">Akidah</th>
                                                <th className="p-4 min-w-[80px]">Ibadah</th>
                                                <th className="p-4 min-w-[80px]">Sirah</th>
                                                <th className="p-4 min-w-[80px]">Adab</th>
                                                <th className="p-4 min-w-[80px]">Jawi</th>
                                                <th className="p-4 min-w-[100px]">Hasil Kerja</th>
                                                <th className="p-4 min-w-[100px] bg-blue-50 text-blue-800 text-center">Keseluruhan</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {classStudents.map(student => {
                                                const pbd = student.pbd_scores || {};
                                                return (
                                                    <tr key={student.id} className="hover:bg-gray-50 group">
                                                        <td className="p-3 sticky left-0 bg-white group-hover:bg-gray-50 border-r z-10 font-medium text-gray-800">{student.name}</td>
                                                        <td className="p-3 bg-emerald-50/30 text-emerald-700 font-medium text-xs">
                                                            {student.level} <br/> <span className="text-[10px] text-gray-500">({student.status})</span>
                                                        </td>
                                                        {['aq_quran', 'akidah', 'ibadah', 'sirah', 'adab', 'jawi'].map(field => (
                                                            <td key={field} className="p-2">
                                                                <select 
                                                                    className="w-full p-1 border rounded text-xs bg-white focus:ring-1 focus:ring-blue-500"
                                                                    value={pbd[field] || ''}
                                                                    onChange={(e) => handleUpdatePBD(student.id, field, e.target.value)}
                                                                >
                                                                    <option value="">-</option>
                                                                    {TP_LEVELS.map(tp => <option key={tp} value={tp}>{tp}</option>)}
                                                                </select>
                                                            </td>
                                                        ))}
                                                        <td className="p-2">
                                                            <select 
                                                                className="w-full p-1 border rounded text-xs bg-white focus:ring-1 focus:ring-blue-500"
                                                                value={pbd['hasil_kerja'] || ''}
                                                                onChange={(e) => handleUpdatePBD(student.id, 'hasil_kerja', e.target.value)}
                                                            >
                                                                <option value="">-</option>
                                                                {HASIL_KERJA_LEVELS.map(val => <option key={val} value={val}>{val}</option>)}
                                                            </select>
                                                        </td>
                                                        <td className="p-2 bg-blue-50/30">
                                                            <select 
                                                                className="w-full p-1 border border-blue-200 rounded text-xs bg-white font-bold text-blue-700 text-center"
                                                                value={pbd['keseluruhan'] || ''}
                                                                onChange={(e) => handleUpdatePBD(student.id, 'keseluruhan', e.target.value)}
                                                            >
                                                                <option value="">-</option>
                                                                {TP_LEVELS.map(tp => <option key={tp} value={tp}>{tp}</option>)}
                                                            </select>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                                {classStudents.length === 0 && <div className="p-8 text-center text-gray-400 italic">Tiada murid dalam kelas ini.</div>}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // --- VIEW: j-QAF ---
        const JQAFHome = () => (
            <div className="p-6 flex flex-col items-center justify-center min-h-[50vh] text-center">
                <div className="bg-purple-100 p-6 rounded-full mb-4">
                    <Star size={48} className="text-purple-600"/>
                </div>
                <h2 className="text-2xl font-bold text-gray-800">Modul j-QAF</h2>
                <p className="text-gray-500 max-w-md mt-2">Fungsi ini sedang dibangunkan. Akan datang: Rekod Kem Cemerlang Jawi & Pemulihan Jawi.</p>
            </div>
        );

        // --- ADMIN DATA PANEL (FULL CODE) ---
        const AdminDataPanel = ({ students, analysisStats, teachersList, whitelist, appSettings, currentUser, setFilterClass, filterClass, uniqueClasses, addToWhitelist, removeUser, approveTeacher, handleSaveSettings, downloadAllStudents, handleImportStudents, setShowAddStudentModal, studentFileRef }) => {
            if (currentUser.role !== 'admin') return <div className="p-6 text-red-500">Akses Ditolak.</div>;
            
            const pendingTeachers = teachersList.filter(t => t.role === 'pending');
            const activeTeachers = teachersList.filter(t => t.role === 'teacher' || t.role === 'admin');
            const [wlName, setWlName] = useState('');
            const [wlEmail, setWlEmail] = useState('');
            const [scriptUrl, setScriptUrl] = useState(appSettings.googleScriptUrl || '');

            return (
                <div className="p-4 md:p-6 max-w-5xl mx-auto pb-20">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Database className="text-gray-600"/> Pengurusan Data Pusat</h2>

                    {/* FILTER KELAS UTAMA UNTUK ADMIN */}
                    <div className="mb-6 flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100 overflow-x-auto">
                        <span className="font-bold text-gray-700 text-sm whitespace-nowrap">Tapis Data Mengikut Kelas:</span>
                        <select 
                            className="p-2 border rounded-lg bg-gray-50 text-sm min-w-[200px]" 
                            value={filterClass} 
                            onChange={(e) => setFilterClass(e.target.value)}
                        >
                            <option value="Semua">Semua Kelas</option>
                            {uniqueClasses.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>

                    {/* ANALISIS TERPERINCI */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg flex items-center gap-2"><BarChart2 size={20}/> Statistik Terperinci</h3>
                            <span className="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">Paparan: {filterClass}</span>
                        </div>
                        
                        <div className="grid md:grid-cols-2 gap-8">
                            {/* Jadual Iqra */}
                            <div>
                                <h4 className="font-bold text-blue-600 mb-2 border-b pb-1">Analisis Iqra'</h4>
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 text-left">
                                        <tr><th className="p-2">Tahap</th><th className="p-2 text-right">Bil. Murid</th></tr>
                                    </thead>
                                    <tbody>
                                        {['Iqra 1', 'Iqra 2', 'Iqra 3', 'Iqra 4', 'Iqra 5', 'Iqra 6'].map(lvl => (
                                            <tr key={lvl} className="border-b">
                                                <td className="p-2 text-gray-700">{lvl}</td>
                                                <td className="p-2 text-right font-bold">{analysisStats.iqra[lvl]}</td>
                                            </tr>
                                        ))}
                                        <tr className="bg-blue-50 font-bold">
                                            <td className="p-2">Jumlah Iqra'</td>
                                            <td className="p-2 text-right">{analysisStats.totalIqra}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            {/* Jadual Quran */}
                            <div>
                                <h4 className="font-bold text-emerald-600 mb-2 border-b pb-1">Analisis Al-Quran</h4>
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-50 text-left">
                                        <tr><th className="p-2">Juzuk</th><th className="p-2 text-right">Bil. Murid</th></tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(analysisStats.quran).map(range => (
                                            <tr key={range} className="border-b">
                                                <td className="p-2 text-gray-700">Juzuk {range}</td>
                                                <td className="p-2 text-right font-bold">{analysisStats.quran[range]}</td>
                                            </tr>
                                        ))}
                                        <tr className="bg-emerald-50 font-bold">
                                            <td className="p-2">Jumlah Al-Quran</td>
                                            <td className="p-2 text-right">{analysisStats.totalQuran}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* TETAPAN GOOGLE SHEETS */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Settings size={20}/> Integrasi Google Sheets (App Script)</h3>
                        <p className="text-sm text-gray-500 mb-2">Data akan dihantar secara automatik ke Google Sheet setiap kali guru mengemaskini data.</p>
                        <div className="flex gap-2">
                            <input 
                                type="text" 
                                className="flex-1 border border-gray-300 rounded-lg p-2 text-sm" 
                                placeholder="Masukkan URL Web App (e.g. https://script.google.com/...)" 
                                value={scriptUrl} 
                                onChange={e => setScriptUrl(e.target.value)} 
                            />
                            <Button onClick={() => handleSaveSettings(scriptUrl)}>Simpan</Button>
                        </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-6 mb-8">
                        {/* Card Backup */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Download size={20}/> Backup Data</h3>
                            <p className="text-sm text-gray-500 mb-4">Muat turun fail backup lengkap (.csv) yang mengandungi semua data murid, markah PBD, dan status tasmik.</p>
                            <Button onClick={downloadAllStudents} className="w-full">Muat Turun Backup</Button>
                        </div>
                         {/* Card Import */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Upload size={20}/> Import / Restore Data</h3>
                            <p className="text-sm text-gray-500 mb-4">Gunakan fail backup untuk memulihkan data jika hilang, atau import senarai nama baru (Format: Nama, Kelas).</p>
                            <div className="flex gap-2">
                                <input type="file" ref={studentFileRef} onChange={handleImportStudents} className="hidden" accept=".csv" />
                                <Button variant="secondary" onClick={() => studentFileRef.current.click()} className="flex-1">Pilih Fail Backup/CSV</Button>
                                <Button variant="secondary" onClick={() => setShowAddStudentModal(true)} className="flex-1">Manual</Button>
                            </div>
                        </div>
                    </div>

                    {/* Pengurusan Guru */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 mb-8">
                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Shield size={20}/> Pengurusan Guru</h3>
                        
                        <div className="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                            <h4 className="text-sm font-bold text-gray-700 mb-2">Tambah Whitelist (Auto-Approve)</h4>
                            <div className="flex flex-col md:flex-row gap-2">
                                <input type="text" placeholder="Nama Guru" className="border p-2 rounded flex-1" value={wlName} onChange={e => setWlName(e.target.value)} />
                                <input type="email" placeholder="Emel Google" className="border p-2 rounded flex-1" value={wlEmail} onChange={e => setWlEmail(e.target.value)} />
                                <Button onClick={() => { addToWhitelist(wlName, wlEmail); setWlName(''); setWlEmail(''); }} disabled={!wlEmail}>Tambah</Button>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 className="font-bold text-orange-600 mb-3 text-sm">Menunggu Kelulusan ({pendingTeachers.length})</h4>
                                {pendingTeachers.length === 0 && <p className="text-gray-400 text-xs italic">Tiada guru pending.</p>}
                                <div className="space-y-2 max-h-[300px] overflow-y-auto">
                                    {pendingTeachers.map(t => (
                                        <div key={t.id} className="bg-white p-3 rounded border border-orange-100 shadow-sm flex justify-between items-center">
                                            <div><p className="font-bold text-sm">{t.name}</p><p className="text-xs text-gray-500">{t.email}</p></div>
                                            <div className="flex gap-1">
                                                <Button onClick={() => removeUser(t.id)} variant="danger" className="px-2 py-1 text-xs">X</Button>
                                                <Button onClick={() => approveTeacher(t.id)} className="px-2 py-1 text-xs">✓</Button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h4 className="font-bold text-emerald-600 mb-3 text-sm">Guru Aktif ({activeTeachers.length})</h4>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto">
                                    {activeTeachers.map(t => (
                                        <div key={t.id} className="bg-white p-3 rounded border border-gray-100 flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <div className="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-700 font-bold text-xs">{t.name.charAt(0)}</div>
                                                <div><p className="font-bold text-sm">{t.name}</p><p className="text-[10px] text-gray-400">{t.email}</p></div>
                                            </div>
                                            {t.role === 'admin' ? <span className="bg-blue-100 text-blue-700 text-[10px] px-1 rounded">ADMIN</span> : 
                                            <button onClick={() => removeUser(t.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={16}/></button>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- SKRIN SETUP HALAQAH ---
        const SetupHalaqahScreen = ({ assignedClass, uniqueClasses, students, currentUser, setView, handleSaveHalaqah }) => {
            const [formClass, setFormClass] = useState(assignedClass || (uniqueClasses.length > 0 ? uniqueClasses[0] : ''));
            const [selectedIds, setSelectedIds] = useState([]);
            
            const classStudents = students.filter(s => s.class === formClass);

            useEffect(() => {
                const myStudents = classStudents.filter(s => s.assignedTeacherEmail === currentUser.email).map(s => s.id);
                setSelectedIds(myStudents);
            }, [formClass, students]);

            const toggleSelection = (id) => selectedIds.includes(id) ? setSelectedIds(selectedIds.filter(sid => sid !== id)) : setSelectedIds([...selectedIds, id]);

            const handleSave = () => {
                const originalMyStudents = classStudents.filter(s => s.assignedTeacherEmail === currentUser.email).map(s => s.id);
                const unselectedIds = originalMyStudents.filter(id => !selectedIds.includes(id));
                handleSaveHalaqah(selectedIds, unselectedIds);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col pb-20">
                     <div className="bg-white px-4 py-4 shadow-sm sticky top-0 z-10 border-b border-gray-100 flex items-center gap-3">
                        <button onClick={() => setView('dashboard')}><ArrowLeft className="text-gray-600" /></button>
                        <div><h2 className="text-lg font-bold text-emerald-800">Setup Halaqah</h2><p className="text-xs text-gray-500">Tanda murid dalam halaqah anda.</p></div>
                    </div>
                    <div className="p-4 bg-white border-b">
                         <label className="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                         <select className="w-full p-2 border rounded-lg bg-gray-50" value={formClass} onChange={e => setFormClass(e.target.value)}>
                            {uniqueClasses.length === 0 ? <option value="">Tiada Kelas (Import Data Dahulu)</option> : null}
                            {uniqueClasses.map(c => <option key={c} value={c}>{c}</option>)}
                         </select>
                    </div>
                    <div className="p-4 space-y-3 max-w-2xl mx-auto w-full">
                        {classStudents.length === 0 && <p className="text-center text-gray-400 py-8">Tiada murid dalam kelas ini.</p>}
                        {classStudents.map(student => {
                            const isAssignedToMe = student.assignedTeacherEmail === currentUser.email;
                            const isAssignedToOther = student.assignedTeacherEmail && !isAssignedToMe;
                            const isSelected = selectedIds.includes(student.id);
                            return (
                                <div key={student.id} onClick={() => !isAssignedToOther && toggleSelection(student.id)} className={`p-4 rounded-xl border flex items-center justify-between cursor-pointer transition-all ${isSelected ? 'bg-emerald-50 border-emerald-500 shadow-sm' : isAssignedToOther ? 'bg-gray-100 border-gray-200 opacity-60 cursor-not-allowed' : 'bg-white border-gray-200'}`}>
                                    <div>
                                        <h4 className="font-bold text-gray-800">{student.name}</h4>
                                        <p className="text-xs text-gray-500">{student.level}</p>
                                        {isAssignedToOther && <span className="text-xs text-red-400 italic">Guru: {student.assignedTeacherName}</span>}
                                    </div>
                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isSelected ? 'bg-emerald-500 border-emerald-500' : 'border-gray-300'}`}>{isSelected && <CheckCircle className="text-white w-4 h-4" />}</div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-lg lg:left-64">
                         <div className="max-w-2xl mx-auto"><Button onClick={handleSave} className="w-full justify-center">Simpan Halaqah</Button></div>
                    </div>
                </div>
            );
        };

        // --- STUDENT DETAIL ---
        const StudentDetail = ({ selectedStudent, records, handleToggleKhatam, handleUpdateTasmik, setView, setSelectedStudent }) => {
            const studentHistory = records.filter(r => r.studentId === selectedStudent.id);
            const [formData, setFormData] = useState({
                level: selectedStudent.level, page: selectedStudent.page, rating: selectedStudent.status || 'Sederhana', comment: ''
            });
            const currentJuzuk = formData.level === 'Al-Quran' ? getExactJuzuk(formData.page) : null;

            return (
                <div className="pb-20 pt-6">
                     <div className="max-w-3xl mx-auto px-4">
                        <button onClick={() => setView('dashboard')} className="flex items-center text-emerald-600 mb-4 hover:underline"><ChevronRight className="rotate-180 w-5 h-5" /> Kembali</button>
                        <div className="bg-emerald-600 text-white p-6 rounded-2xl shadow-lg mb-6 relative overflow-hidden">
                            {selectedStudent.isKhatam && <div className="absolute top-0 right-0 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-bl-xl flex items-center gap-1 shadow-md"><Award size={14} /> TELAH KHATAM</div>}
                            <h2 className="text-3xl font-bold">{selectedStudent.name}</h2>
                            <div className="flex items-center gap-3 mt-2 opacity-90">
                                <span className="bg-emerald-700 px-3 py-1 rounded-full text-sm">{selectedStudent.class}</span>
                            </div>
                        </div>
                        <Card className="mb-6 border-emerald-200 ring-4 ring-emerald-50">
                            <div className="flex items-center gap-2 mb-4 text-emerald-800 font-bold border-b pb-2"><FileText size={20} /><h3>Kemaskini Bacaan</h3></div>
                            <div className="space-y-4">
                                
                                <div className="flex items-start gap-3 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <input 
                                        type="checkbox" 
                                        id="khatamCheck"
                                        className="mt-1 w-5 h-5 text-emerald-600 rounded focus:ring-emerald-500"
                                        checked={selectedStudent.isKhatam} 
                                        onChange={() => handleToggleKhatam(selectedStudent.id, selectedStudent.isKhatam)}
                                    />
                                    <div>
                                        <label htmlFor="khatamCheck" className="text-sm font-bold text-yellow-800 cursor-pointer block">
                                            Tanda sebagai Khatam (Lengkap 30 Juzuk)
                                        </label>
                                        <p className="text-xs text-yellow-600 mt-1">
                                            Tanda kotak ini jika murid telah khatam. Murid akan mendapat lencana khas. Anda boleh menukar Tahap bacaan ke permulaan semula untuk pusingan seterusnya.
                                        </p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Tahap</label>
                                        <select className="w-full p-2 border rounded-lg bg-gray-50" value={formData.level} onChange={(e) => setFormData({...formData, level: e.target.value})}>
                                            {LEVELS.map(l => <option key={l} value={l}>{l}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">Muka Surat</label>
                                        <input type="number" className="w-full p-2 border rounded-lg bg-gray-50" value={formData.page} onChange={(e) => setFormData({...formData, page: e.target.value})} />
                                        {formData.level === 'Al-Quran' && <span className="text-xs text-emerald-600 font-bold block mt-1">Juzuk {currentJuzuk} (Tepat)</span>}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Kelancaran</label>
                                    <div className="flex gap-2">
                                        {RATINGS.map(r => (
                                            <button key={r} onClick={() => setFormData({...formData, rating: r})} className={`flex-1 py-2 text-sm rounded-lg border transition-all ${formData.rating === r ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white text-gray-600 hover:bg-gray-50'}`}>{r}</button>
                                        ))}
                                    </div>
                                </div>
                                <input type="text" className="w-full p-2 border rounded-lg bg-gray-50" placeholder="Catatan (Opsyenal)" value={formData.comment} onChange={(e) => setFormData({...formData, comment: e.target.value})} />
                                <Button onClick={() => handleUpdateTasmik(selectedStudent.id, formData)} className="w-full py-3 text-lg"><Save size={20} /> Simpan Rekod</Button>
                            </div>
                        </Card>
                        <div className="space-y-3">
                            <h3 className="text-gray-500 font-bold mb-3 flex items-center gap-2"><History size={18} /> Sejarah Tasmik</h3>
                            {studentHistory.length === 0 ? <p className="text-gray-400 text-center py-8">Tiada rekod.</p> : studentHistory.map(record => (
                                <div key={record.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-start">
                                    <div>
                                        <div className="flex items-center gap-2"><span className="font-bold text-emerald-900">{record.level}</span><span className="text-gray-400">|</span><span>Ms. {record.page}</span></div>
                                        <div className="text-xs text-gray-400 mt-1">{record.date} • {record.teacher}</div>
                                    </div>
                                    <Badge status={record.rating} />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VIEW: PORTAL HOME (UPDATED) ---
        const PortalHome = ({ currentUser, students, setView }) => (
            <div className="p-6 max-w-6xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-800">Selamat Datang, {currentUser.name}!</h1>
                    <p className="text-gray-500">Portal Digitalisasi Panitia Pendidikan Islam</p>
                </div>
                
                <DailyHadis />

                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div onClick={() => setView('dashboard')} className="bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-6 text-white shadow-lg cursor-pointer transform hover:scale-105 transition-all">
                        <Book size={40} className="mb-4 opacity-80"/>
                        <h3 className="text-xl font-bold">e-Tasmik</h3>
                        <p className="text-emerald-100 text-sm mt-1">Rekod bacaan Al-Quran & Iqra murid.</p>
                    </div>
                    <div onClick={() => setView('pbd_list')} className="bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl p-6 text-white shadow-lg cursor-pointer transform hover:scale-105 transition-all">
                        <Clipboard size={40} className="mb-4 opacity-80"/>
                        <h3 className="text-xl font-bold">Pentaksiran (PBD)</h3>
                        <p className="text-blue-100 text-sm mt-1">Rekod TP untuk Akidah, Ibadah, Jawi & lain-lain.</p>
                    </div>
                    <div onClick={() => setView('jqaf_home')} className="bg-gradient-to-br from-purple-500 to-purple-700 rounded-2xl p-6 text-white shadow-lg cursor-pointer transform hover:scale-105 transition-all">
                        <Star size={40} className="mb-4 opacity-80"/>
                        <h3 className="text-xl font-bold">j-QAF</h3>
                        <p className="text-purple-100 text-sm mt-1">Modul Pemulihan Jawi & Khatam Quran.</p>
                    </div>
                </div>

                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                    <h3 className="font-bold text-gray-800 mb-4">Statistik Ringkas</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-gray-50 p-4 rounded-lg text-center">
                            <span className="block text-2xl font-bold text-gray-700">{students.length}</span>
                            <span className="text-xs text-gray-500 uppercase">Jumlah Murid</span>
                        </div>
                        <div className="bg-emerald-50 p-4 rounded-lg text-center">
                            <span className="block text-2xl font-bold text-emerald-600">{students.filter(s=>s.level==='Al-Quran').length}</span>
                            <span className="text-xs text-emerald-500 uppercase">Murid Al-Quran</span>
                        </div>
                        <div className="bg-yellow-50 p-4 rounded-lg text-center">
                            <span className="block text-2xl font-bold text-yellow-600">{students.filter(s=>s.isKhatam).length}</span>
                            <span className="text-xs text-yellow-500 uppercase">Telah Khatam</span>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- LOGIK APLIKASI UTAMA ---
        function App() {
            // Auth State
            const [currentUser, setCurrentUser] = useState(null); 
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            // Data State (Firebase)
            const [students, setStudents] = useState([]);
            const [records, setRecords] = useState([]);
            const [teachersList, setTeachersList] = useState([]); 
            const [whitelist, setWhitelist] = useState([]);
            const [appSettings, setAppSettings] = useState({});

            // UI State
            const [view, setView] = useState('portal_home'); // Default view
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [notification, setNotification] = useState(null);
            const [filterClass, setFilterClass] = useState('Semua');
            const [searchTerm, setSearchTerm] = useState('');
            const [assignedClass, setAssignedClass] = useState(null); 
            const [showAddStudentModal, setShowAddStudentModal] = useState(false);
            
            const [hasWelcomed, setHasWelcomed] = useState(false);
            const studentFileRef = useRef(null);

            // Derived State: Senarai kelas unik
            const uniqueClasses = useMemo(() => {
                const classes = students.map(s => s.class).filter(c => c);
                return [...new Set(classes)].sort();
            }, [students]);

            // Derived State: Kelas-kelas yang guru ini ada murid
            const myClasses = useMemo(() => {
                if (!currentUser || (currentUser.role !== 'teacher' && currentUser.role !== 'admin')) return [];
                const classes = students
                    .filter(s => s.assignedTeacherEmail === currentUser.email)
                    .map(s => s.class);
                return [...new Set(classes)].sort();
            }, [students, currentUser]);

            // UPDATE: Analisis Terperinci (Admin)
            const analysisStats = useMemo(() => {
                const subset = students.filter(s => filterClass === 'Semua' || s.class === filterClass);
                
                const stats = {
                    iqra: { 'Iqra 1': 0, 'Iqra 2': 0, 'Iqra 3': 0, 'Iqra 4': 0, 'Iqra 5': 0, 'Iqra 6': 0 },
                    quran: { '1-5': 0, '6-10': 0, '11-15': 0, '16-20': 0, '21-25': 0, '26-30': 0 },
                    khatam: 0,
                    totalIqra: 0,
                    totalQuran: 0,
                    total: subset.length
                };

                subset.forEach(s => {
                    if (s.isKhatam) stats.khatam++;
                    
                    if (s.level.startsWith('Iqra')) {
                        if (stats.iqra[s.level] !== undefined) {
                            stats.iqra[s.level]++;
                            stats.totalIqra++;
                        }
                    } else if (s.level === 'Al-Quran') {
                        stats.totalQuran++;
                        const j = getExactJuzuk(s.page);
                        // Pastikan j adalah nombor
                        if (typeof j === 'number') {
                            if (j >= 1 && j <= 5) stats.quran['1-5']++;
                            else if (j >= 6 && j <= 10) stats.quran['6-10']++;
                            else if (j >= 11 && j <= 15) stats.quran['11-15']++;
                            else if (j >= 16 && j <= 20) stats.quran['16-20']++;
                            else if (j >= 21 && j <= 25) stats.quran['21-25']++;
                            else if (j >= 26 && j <= 30) stats.quran['26-30']++;
                        }
                    }
                });
                return stats;
            }, [students, filterClass]);

            // --- EFFECTS ---

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const userRef = db.collection('users').doc(user.uid);
                        const doc = await userRef.get();

                        if (!doc.exists) {
                            const usersSnapshot = await db.collection('users').get();
                            const isFirstUser = usersSnapshot.empty;
                            const whitelistSnapshot = await db.collection('whitelist').where('email', '==', user.email).get();
                            const isWhitelisted = !whitelistSnapshot.empty;
                            const role = isFirstUser ? 'admin' : (isWhitelisted ? 'teacher' : 'pending');

                            const newUser = {
                                uid: user.uid,
                                email: user.email,
                                name: user.displayName || 'Guru',
                                photoURL: user.photoURL,
                                role: role,
                                createdAt: new Date()
                            };
                            await userRef.set(newUser);
                            setCurrentUser(newUser);
                        } else {
                            setCurrentUser(doc.data());
                        }
                    } else {
                        setCurrentUser(null);
                        setHasWelcomed(false);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (currentUser) {
                    if (currentUser.role === 'pending') {
                        setAuthError("Akaun anda sedang menunggu kelulusan Admin.");
                        setView('login');
                        return;
                    }
                    setAuthError(null);
                    
                    if (!hasWelcomed && view === 'portal_home') {
                        showNotification(`Ahlan wa Sahlan ya ${currentUser.name}`);
                        setHasWelcomed(true);
                    }

                    const unsubStudents = db.collection('students').onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setStudents(data);
                    });

                    const unsubRecords = db.collection('records').orderBy('date', 'desc').limit(500).onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRecords(data);
                    });

                    // Fetch Settings (Global)
                    const unsubSettings = db.collection('settings').doc('general').onSnapshot(doc => {
                        if(doc.exists) setAppSettings(doc.data());
                    });

                    let unsubUsers = () => {};
                    let unsubWhitelist = () => {};
                    
                    if (currentUser.role === 'admin') {
                        unsubUsers = db.collection('users').onSnapshot(snapshot => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setTeachersList(data);
                        });
                        unsubWhitelist = db.collection('whitelist').onSnapshot(snapshot => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setWhitelist(data);
                        });
                    }

                    if (view === 'loading' || view === 'login') {
                         setView('portal_home');
                    }

                    return () => { unsubStudents(); unsubRecords(); unsubUsers(); unsubWhitelist(); unsubSettings(); };
                } else {
                    setView('login');
                    setStudents([]);
                    setRecords([]);
                }
            }, [currentUser]); 


            // --- ACTIONS ---

            const handleGoogleLogin = async () => {
                try {
                    await auth.signInWithPopup(googleProvider);
                } catch (error) {
                    console.error("Login failed", error);
                    setAuthError("Gagal log masuk.");
                }
            };

            const handleLogout = () => {
                auth.signOut();
                setAssignedClass(null);
            };

            const showNotification = (msg) => {
                setNotification(msg);
                setTimeout(() => setNotification(null), 4000);
            };

            // --- DATA ACTIONS ---
            const handleImportStudents = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const text = evt.target.result;
                    const rows = text.split('\n');
                    let count = 0;
                    const batch = db.batch();
                    
                    const header = rows[0] || "";
                    const isBackup = header.includes("PBD_Keseluruhan");

                    const dataRows = rows.slice(1);

                    dataRows.forEach((row) => {
                        if (!row.trim()) return;
                        
                        const cols = row.split(','); 
                        const clean = (val) => val ? val.replace(/^"|"$/g, '').trim() : '';

                        if (isBackup && cols.length >= 7) {
                            const id = clean(cols[0]);
                            const name = clean(cols[1]);
                            const kelas = clean(cols[2]);
                            
                            if (id && name) {
                                const ref = db.collection('students').doc(id.length > 5 ? id : undefined); 
                                
                                const pbd_scores = {
                                    aq_quran: clean(cols[8]),
                                    akidah: clean(cols[9]),
                                    ibadah: clean(cols[10]),
                                    sirah: clean(cols[11]),
                                    adab: clean(cols[12]),
                                    jawi: clean(cols[13]),
                                    hasil_kerja: clean(cols[14]),
                                    keseluruhan: clean(cols[15]),
                                };

                                batch.set(ref, {
                                    name: name,
                                    class: kelas,
                                    assignedTeacherName: clean(cols[3]) || null,
                                    assignedTeacherEmail: null, 
                                    level: clean(cols[4]) || 'Iqra 1',
                                    page: clean(cols[5]) || '1',
                                    status: clean(cols[6]) || 'Sederhana',
                                    isKhatam: clean(cols[7]) === 'true',
                                    pbd_scores: pbd_scores,
                                    restoredAt: new Date()
                                }, { merge: true });
                                count++;
                            }

                        } else if (cols.length >= 2) {
                            const name = clean(cols[0]);
                            const kelas = clean(cols[1]);
                            if(name && kelas) {
                                const newRef = db.collection('students').doc();
                                batch.set(newRef, {
                                    name: name,
                                    class: kelas,
                                    assignedTeacherEmail: null,
                                    assignedTeacherName: null,
                                    level: 'Iqra 1',
                                    page: '1',
                                    status: 'Sederhana',
                                    isKhatam: false,
                                    createdAt: new Date(),
                                    pbd_scores: {}
                                });
                                count++;
                            }
                        }
                    });

                    if (count > 0) {
                        await batch.commit();
                        showNotification(`${count} murid berjaya dipulihkan/diimport!`);
                    } else {
                        showNotification("Fail kosong atau format salah.");
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleAddStudent = async (name, kelas) => {
                try {
                    await db.collection('students').add({
                        name: name,
                        class: kelas,
                        assignedTeacherEmail: null,
                        assignedTeacherName: null,
                        level: 'Iqra 1',
                        page: '1',
                        status: 'Sederhana',
                        isKhatam: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        pbd_scores: {}
                    });
                    showNotification("Murid berjaya ditambah!");
                    setShowAddStudentModal(false);
                } catch(e) {
                    console.error(e);
                    showNotification("Ralat menambah murid.");
                }
            };

            const handleDeleteStudent = async (studentId, studentName) => {
                if(!window.confirm(`ADAKAH ANDA PASTI?\n\nMurid: ${studentName}\n\nTindakan ini akan memadam data murid ini sepenuhnya. Sejarah bacaan tidak akan dapat dikaitkan semula.`)) return;
                try {
                    await db.collection('students').doc(studentId).delete();
                    showNotification("Murid berjaya dipadam.");
                } catch(e) {
                    console.error(e);
                    showNotification("Gagal memadam murid.");
                }
            };

            const handleSaveHalaqah = async (selectedIds, unselectedIds) => {
                const batch = db.batch();
                selectedIds.forEach(id => {
                    const ref = db.collection('students').doc(id);
                    batch.update(ref, { assignedTeacherEmail: currentUser.email, assignedTeacherName: currentUser.name });
                });
                unselectedIds.forEach(id => {
                    const ref = db.collection('students').doc(id);
                    batch.update(ref, { assignedTeacherEmail: null, assignedTeacherName: null });
                });
                await batch.commit();
                showNotification("Halaqah berjaya dikemaskini!");
                setView('dashboard');
                setAssignedClass(null); 
            };

            const handleDeleteHalaqah = async (className) => {
                if (!window.confirm(`Adakah anda pasti mahu memadam halaqah untuk kelas ${className}? Semua murid akan dinyah-assign.`)) return;
                const studentsInHalaqah = students.filter(s => s.class === className && s.assignedTeacherEmail === currentUser.email);
                const batch = db.batch();
                studentsInHalaqah.forEach(s => {
                    const ref = db.collection('students').doc(s.id);
                    batch.update(ref, { assignedTeacherEmail: null, assignedTeacherName: null });
                });
                await batch.commit();
                showNotification(`Halaqah kelas ${className} berjaya dipadam.`);
            };

            const handleUpdateTasmik = async (studentId, newData) => {
                const today = new Date().toISOString().split('T')[0];
                const studentData = { level: newData.level, page: newData.page, status: newData.rating };
                
                await db.collection('records').add({
                    studentId, date: today, teacher: currentUser.name, email: currentUser.email, ...newData, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('students').doc(studentId).update(studentData);
                
                syncToGoogleSheets({ type: 'TASMIK', studentId, teacher: currentUser.name, ...studentData, ...newData }, appSettings);

                showNotification("Rekod disimpan!");
                setView('dashboard');
            };

            const handleUpdatePBD = async (studentId, field, value) => {
                try {
                    await db.collection('students').doc(studentId).update({
                        [`pbd_scores.${field}`]: value
                    });

                    syncToGoogleSheets({ type: 'PBD', studentId, field, value, teacher: currentUser.name }, appSettings);

                } catch(e) {
                    console.error("Gagal update PBD", e);
                    showNotification("Ralat menyimpan PBD");
                }
            };

            const handleSaveSettings = async (url) => {
                await db.collection('settings').doc('general').set({ googleScriptUrl: url }, { merge: true });
                showNotification("Tetapan disimpan.");
            };

            const handleToggleKhatam = async (studentId, currentStatus) => {
                await db.collection('students').doc(studentId).update({ isKhatam: !currentStatus });
                if (selectedStudent && selectedStudent.id === studentId) {
                    setSelectedStudent(prev => ({ ...prev, isKhatam: !currentStatus }));
                }
                const msg = !currentStatus ? "Tahniah! Murid telah Khatam." : "Status Khatam dibatalkan.";
                showNotification(msg);
            };

             const downloadHistory = (type = 'all') => {
                let csvContent = "data:text/csv;charset=utf-8,Tarikh,Nama Murid,Kelas,Guru Tasmik,Tahap,Muka Surat,Kelancaran,Catatan\n";
                const recordsToExport = records.filter(rec => {
                    if (type === 'all') return true;
                    const student = students.find(s => s.id === rec.studentId);
                    return student && (filterClass === 'Semua' || student.class === filterClass);
                });
                recordsToExport.forEach(rec => {
                    const student = students.find(s => s.id === rec.studentId);
                    if (student) {
                        const safeComment = (rec.comment || '').replace(/,/g, ';');
                        csvContent += `${rec.date},${student.name},${student.class},${rec.teacher},${rec.level},${rec.page},${rec.rating},${safeComment}\n`;
                    }
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Sejarah_Bacaan.csv`);
                document.body.appendChild(link);
                link.click();
            };
            
            const downloadAllStudents = () => {
                let csvContent = "data:text/csv;charset=utf-8,ID,Nama Murid,Kelas,Guru Tasmik,Tahap Tasmik,Muka Surat,Status,Khatam,PBD_AQ,PBD_Akidah,PBD_Ibadah,PBD_Sirah,PBD_Adab,PBD_Jawi,PBD_HasilKerja,PBD_Keseluruhan\n";
                students.forEach(s => {
                    const pbd = s.pbd_scores || {};
                    csvContent += `${s.id},"${s.name}",${s.class},"${s.assignedTeacherName || ''}",${s.level},${s.page},${s.status},${s.isKhatam},${pbd.aq_quran || ''},${pbd.akidah || ''},${pbd.ibadah || ''},${pbd.sirah || ''},${pbd.adab || ''},${pbd.jawi || ''},${pbd.hasil_kerja || ''},${pbd.keseluruhan || ''}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Data_Murid_Lengkap_Backup.csv`);
                document.body.appendChild(link);
                link.click();
            }

            const approveTeacher = async (userId) => {
                await db.collection('users').doc(userId).update({ role: 'teacher' });
                showNotification("Guru diluluskan!");
            };
            const removeUser = async (userId) => {
                if(window.confirm("Padam pengguna ini?")) await db.collection('users').doc(userId).delete();
            };
            const addToWhitelist = async (name, email) => {
                if (!email) return;
                const existing = whitelist.find(w => w.email === email);
                if (existing) { showNotification("Emel sudah ada."); return; }
                await db.collection('whitelist').add({ name: name || 'Guru', email: email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                const existingUser = teachersList.find(t => t.email === email && t.role === 'pending');
                if (existingUser) await db.collection('users').doc(existingUser.id).update({ role: 'teacher' });
                showNotification(`Guru ${name} ditambah.`);
            };

            // --- NAVIGATION SIDEBAR ---
            const Sidebar = ({ activeView, onChangeView, isOpen, toggle }) => {
                const menuItems = [
                    { id: 'portal_home', label: 'Utama', icon: Home },
                    { id: 'dashboard', label: 'e-Tasmik', icon: Book },
                    { id: 'pbd_list', label: 'Borang PBD', icon: Clipboard },
                    { id: 'jqaf_home', label: 'j-QAF', icon: Star },
                ];
                
                if(currentUser.role === 'admin') {
                    menuItems.push({ id: 'admin_panel', label: 'Pengurusan Data', icon: Database });
                }

                return (
                    <>
                        {isOpen && <div className="fixed inset-0 bg-black/50 z-20 lg:hidden" onClick={toggle}></div>}
                        <div className={`fixed lg:static inset-y-0 left-0 w-64 bg-emerald-800 text-white z-30 transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0 sidebar-transition flex flex-col shadow-2xl`}>
                            <div className="p-6 border-b border-emerald-700">
                                <h1 className="text-xl font-bold flex flex-col">
                                    <span className="flex items-center gap-2"><Book className="text-emerald-300"/> Digitalisasi Panitia</span>
                                    <span className="text-xs text-emerald-300 font-normal mt-1">Pendidikan Islam</span>
                                </h1>
                            </div>
                            
                            <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                                {menuItems.map(item => (
                                    <button 
                                        key={item.id} 
                                        onClick={() => { onChangeView(item.id); if(window.innerWidth < 1024) toggle(); }}
                                        className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeView === item.id ? 'bg-emerald-600 text-white shadow-lg' : 'text-emerald-100 hover:bg-emerald-700'}`}
                                    >
                                        <item.icon size={20} />
                                        <span className="font-medium">{item.label}</span>
                                    </button>
                                ))}
                            </nav>

                            <div className="p-4 border-t border-emerald-700 bg-emerald-900/50">
                                <div className="flex items-center gap-3 mb-4">
                                    {currentUser?.photoURL ? 
                                        <img src={currentUser.photoURL} className="w-10 h-10 rounded-full border-2 border-emerald-500" /> : 
                                        <div className="w-10 h-10 rounded-full bg-emerald-600 flex items-center justify-center font-bold">{currentUser?.name.charAt(0)}</div>
                                    }
                                    <div className="overflow-hidden">
                                        <p className="text-sm font-bold truncate">{currentUser?.name}</p>
                                        <p className="text-[10px] text-emerald-300 uppercase">{currentUser?.role}</p>
                                    </div>
                                </div>
                                <Button variant="ghost" onClick={handleLogout} className="w-full justify-start text-red-200 hover:bg-red-900/50 hover:text-red-100">
                                    <LogOut size={18}/> Log Keluar
                                </Button>
                            </div>
                        </div>
                    </>
                );
            };

            // --- SCREENS ---

            const LoadingScreen = () => (
                 <div className="min-h-screen flex flex-col items-center justify-center bg-emerald-50 text-emerald-600">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
                    <p>Memuatkan Portal...</p>
                 </div>
            );

            const LoginScreen = () => (
                <div className="min-h-screen w-full bg-emerald-50 flex flex-col items-center justify-center p-6">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border-t-4 border-emerald-500 relative z-10">
                        <div className="bg-emerald-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Book size={40} className="text-emerald-600" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-1">Portal Digitalisasi Panitia</h1>
                        <p className="text-emerald-600 font-semibold mb-6">Pendidikan Islam</p>
                        {authError && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4 border border-red-200">{authError}</div>}
                        <Button onClick={handleGoogleLogin} variant="google" className="w-full justify-center py-3 shadow-sm">
                            <svg className="w-5 h-5 mr-2" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Log Masuk Google
                        </Button>
                    </div>
                </div>
            );

            // 1. SKRIN LOG MASUK & GUEST
            if (!currentUser || view === 'login') {
                return (
                    <div className="font-sans text-gray-800">
                        {notification && (
                            <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in-up">
                                <div className="bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2">
                                    <CheckCircle size={18} className="text-emerald-400" />
                                    <span className="text-sm font-medium">{notification}</span>
                                </div>
                            </div>
                        )}
                        <LoginScreen />
                    </div>
                );
            }
            
            // 2. APLIKASI UTAMA (SIDEBAR + KONTEN)
            return (
                <div className="font-sans flex min-h-screen bg-gray-50">
                    {/* Notification Toast */}
                    {notification && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 animate-fade-in-up">
                            <div className="bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl flex items-center gap-2">
                                <CheckCircle size={18} className="text-emerald-400" />
                                <span className="text-sm font-medium">{notification}</span>
                            </div>
                        </div>
                    )}
                    
                    {/* SIDEBAR */}
                    <Sidebar activeView={view} onChangeView={setView} isOpen={sidebarOpen} toggle={() => setSidebarOpen(!sidebarOpen)} />
                    
                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex flex-col min-h-screen relative overflow-hidden transition-all lg:ml-0">
                        {/* Mobile Header Toggle */}
                        <div className="lg:hidden bg-emerald-800 text-white p-4 flex justify-between items-center shadow-md">
                            <div className="flex items-center gap-2"><Book/> <span className="font-bold">Panitia PI</span></div>
                            <button onClick={() => setSidebarOpen(true)}><Menu size={24}/></button>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            {view === 'portal_home' && <PortalHome currentUser={currentUser} students={students} setView={setView} />}
                            {view === 'dashboard' && <Dashboard 
                                currentUser={currentUser}
                                students={students}
                                searchTerm={searchTerm}
                                setSearchTerm={setSearchTerm}
                                filterClass={filterClass}
                                setFilterClass={setFilterClass}
                                assignedClass={assignedClass}
                                setAssignedClass={setAssignedClass}
                                myClasses={myClasses}
                                analysisStats={analysisStats}
                                setView={setView}
                                setSelectedStudent={setSelectedStudent}
                                handleDeleteHalaqah={handleDeleteHalaqah}
                                handleDeleteStudent={handleDeleteStudent}
                                uniqueClasses={uniqueClasses}
                            />}
                            {view === 'pbd_list' && <PBDListScreen students={students} uniqueClasses={uniqueClasses} handleUpdatePBD={handleUpdatePBD} />}
                            {view === 'jqaf_home' && <JQAFHome />}
                            {view === 'admin_panel' && <AdminDataPanel 
                                students={students}
                                analysisStats={analysisStats}
                                teachersList={teachersList}
                                whitelist={whitelist}
                                appSettings={appSettings}
                                currentUser={currentUser}
                                setFilterClass={setFilterClass}
                                filterClass={filterClass}
                                uniqueClasses={uniqueClasses}
                                addToWhitelist={addToWhitelist}
                                removeUser={removeUser}
                                approveTeacher={approveTeacher}
                                handleSaveSettings={handleSaveSettings}
                                downloadAllStudents={downloadAllStudents}
                                handleImportStudents={handleImportStudents}
                                setShowAddStudentModal={setShowAddStudentModal}
                                studentFileRef={studentFileRef}
                            />}
                            
                            {/* Sub-Views (Rendered full width but inside layout) */}
                            {view === 'student_detail' && <StudentDetail selectedStudent={selectedStudent} records={records} handleToggleKhatam={handleToggleKhatam} handleUpdateTasmik={handleUpdateTasmik} setView={setView} setSelectedStudent={setSelectedStudent} />}
                            {view === 'setup_halaqah' && <SetupHalaqahScreen assignedClass={assignedClass} uniqueClasses={uniqueClasses} students={students} currentUser={currentUser} setView={setView} handleSaveHalaqah={handleSaveHalaqah} />}
                        </div>
                    </div>

                    {/* Modals */}
                    {showAddStudentModal && <AddStudentModal onClose={() => setShowAddStudentModal(false)} onSave={handleAddStudent} existingClasses={uniqueClasses}/>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
